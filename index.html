<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DouYin TG Feed</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100vh; overflow: hidden; background: #000; color: white; font-family: system-ui; }
    #info { position: fixed; top: 20px; left: 20px; z-index: 100; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; font-size: 14px; }
    .container { height: 100vh; position: relative; overflow: hidden; }
    .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; background: #111; }
    .page.active { transform: translateY(0); z-index: 10; }
    .page.prev { transform: translateY(100%); z-index: 5; }
    .page.next { transform: translateY(-100%); z-index: 5; }
    .page img { width: 100%; height: 100%; object-fit: contain; }
    .page video { width: 100%; height: 100%; object-fit: contain; }
    .favorite { position: absolute; top: 30px; right: 30px; background: rgba(0,0,0,0.5); color: white; border: none; font-size: 24px; padding: 12px; border-radius: 50%; cursor: pointer; z-index: 20; }
    .favorited { color: #ff4757; }
    #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 18px; z-index: 999; }
  </style>
</head>
<body>
  <div id="info">
    <div>用户: <span id="username"></span></div>
    <div>ID: <span id="userId"></span></div>
  </div>
  <div id="loading">加载中...</div>
  <div id="feed" class="container"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.disableVerticalSwipes?.();
    tg.isVerticalSwipesEnabled = false;

    const user = tg.initDataUnsafe?.user;
    const BOT_TOKEN = '8475006065:AAFUo-BetTb5K72P9qBX25EVsmIPSkA4jQk';
    const CHANNEL = 'R_E_STUDIO';

    let items = [];
    let currentIndex = 0;

    async function loadFeed() {
      try {
        const res = await fetch(`/api/channel?channel=${CHANNEL}`);
        const data = await res.json();

        if (data.items && data.items.length > 0) {
          items = data.items.map((item, i) => ({
            id: i + 1,
            chatId: '@' + CHANNEL,
            url: item.url,
            type: item.type
          }));
        } else {
          useFallback();
        }
      } catch(e) {
        useFallback();
      }
      document.getElementById('loading').style.display = 'none';
      renderFeed();
    }

    function useFallback() {
      items = [
        { id: 1, chatId: '@demo1', url: 'https://picsum.photos/400/700?random=1', type: 'photo' },
        { id: 2, chatId: '@demo2', url: 'https://picsum.photos/400/700?random=2', type: 'photo' },
        { id: 3, chatId: '@demo3', url: 'https://picsum.photos/400/700?random=3', type: 'photo' }
      ];
    }

    function renderFeed() {
      const container = document.getElementById('feed');
      container.innerHTML = items.map((item, index) => `
        <div class="page ${index === 0 ? 'active' : 'next'}" data-index="${index}">
          ${item.type === 'video'
            ? `<video src="${item.url}" autoplay muted loop playsinline></video>`
            : `<img src="${item.url}" alt="内容${index+1}">`
          }
          <button class="favorite" onclick="toggleFavorite(${item.id}, '${item.chatId}')">♡</button>
        </div>
      `).join('');

      if (user) {
        document.getElementById('username').textContent = user.username || user.first_name;
        document.getElementById('userId').textContent = user.id;
      }

      bindSwipe(container);
    }

    function bindSwipe(container) {
      let startY = null;
      let currentY = null;

      container.ontouchstart = (e) => {
        if (!e.touches.length) return;
        startY = e.touches[0].clientY;
        currentY = startY;
      };

      container.ontouchmove = (e) => {
        if (!e.touches.length || startY === null) return;
        currentY = e.touches[0].clientY;
      };

      container.ontouchend = () => {
        if (startY === null || currentY === null) return;
        const delta = startY - currentY;
        startY = null;
        currentY = null;
        if (Math.abs(delta) < 40) return;
        if (delta > 0 && currentIndex < items.length - 1) {
          goTo(currentIndex + 1);
        } else if (delta < 0 && currentIndex > 0) {
          goTo(currentIndex - 1);
        }
      };
    }

    function goTo(newIndex) {
      const pages = document.querySelectorAll('.page');
      pages.forEach((p, i) => {
        p.classList.remove('active', 'prev', 'next');
        if (i < newIndex) p.classList.add('prev');
        else if (i === newIndex) p.classList.add('active');
        else p.classList.add('next');
      });
      currentIndex = newIndex;
    }

    window.toggleFavorite = async function (messageId, chatId) {
      const btn = event.target;
      if (btn.classList.contains('favorited')) return;
      if (!user) { tg.showAlert('请在 Telegram 内打开'); return; }
      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: user.id,
            text: `⭐ 收藏: ${chatId} #${messageId}`
          })
        });
        const data = await res.json();
        if (data.ok) {
          btn.classList.add('favorited');
          tg.showAlert('收藏成功！');
        } else {
          tg.showAlert('失败: ' + data.description);
        }
      } catch (e) {
        tg.showAlert('网络错误: ' + e.message);
      }
    };

    loadFeed();
  </script>
</body>
</html>
